<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, user-scalable=no, width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="shortcut icon" type="image/png" href="favicon-512.png">
<title>Emoji</title>
<style>
body {
  background-image: url("Farm-Fresh-Strawberries.jpg");
  background-color: wheat;
  margin: 10px;
  overflow:hidden; /* visible; when using #dbg */
}
.flex {
    position: relative;
    display: flex;
    flex-wrap: wrap;
}
.flex > div {
    cursor: default;
    border-radius: 25%;
    display: flex; 
    background: white;
    justify-content: center;
    align-items: center;
    margin: 5px;
    border: 5px solid tan;
}
.flex > div:after {
    content: ' ';
    padding-top: 100%;
    display: table; 
}
.heart-firework {
    position: absolute;
    font-size: var(--heart-size);
    color: var(--heart-color);
    pointer-events: none;
    transform: translate(-50%, -50%);
    animation: explode 1.5s ease-out forwards;
}

@keyframes explode {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) translate(var(--dx), var(--dy));
    }
}

#dbg { font-size: 20px; background-color: white; font-weight: bold; }
</style></head><body><div class="flex"></div><div class="flex"></div><p>&nbsp;</p><div id='dbg'></div>
<canvas id="fireworksCanvas"></canvas>
<script src="https://unpkg.com/jquery@2.2.4/dist/jquery.min.js"></script>
<script>
'use strict';
Array.prototype.shuffle = function() {
  let currentIndex = this.length;
  while (currentIndex !== 0) {
    let randomIndex = Math.floor(Math.random() * currentIndex--);
    [this[currentIndex], this[randomIndex]] = [this[randomIndex], this[currentIndex]];
  }
  return this; // Return the shuffled array (modified in place)
};

function hasAdjacentEqualElements(arr) {
  for (let i = 0; i < arr.length - 1; i++) {
    if (arr[i] === arr[i + 1]) {
      console.log('adjacentIndex=',i)
      return true; // Found adjacent equal elements
    }
  }
  return false; // No adjacent equal elements found
}
// onChange()
let h, w, m, c;

let card1, card2, guess, errors, animals, timeoutID = null, loopInterval = null, emoji = [].concat(
  Array(36).fill().map((_, i) => String.fromCodePoint(0x1f330 + i)),  // plants & fruits
  Array(44).fill().map((_, i) => String.fromCodePoint(0x1f400 + i)),  // animals
  Array(16).fill().map((_, i) => String.fromCodePoint(0x1f42d + i))   // animals faces
);                                                 // 0x1f9.. emoji's not on Android

function startLoop() {
  $('.flex:last > div').html('üíñ');
  loopInterval = setInterval(triggerRandomFirework, 500);
  timeoutID = setTimeout(() => {
    clearInterval(loopInterval); // Stop the loop
    $('.flex:last > div').html('‚ôªÔ∏è');
  }, 15000);
}

function init() {
  card1 = card2 = null, errors = 0, guess = new Array(16).fill(0);
  $('.flex').html('');

  emoji = emoji.shuffle();
  animals = emoji.slice(0,8).concat(emoji.slice(0,8));
  do {
    animals = animals.shuffle();
  } while (hasAdjacentEqualElements(animals));
  
  animals.forEach(function(_, i) { 
    $('.flex').first().append($(`<div id="${i}">&nbsp;</div>`));
  });
  // https://stackoverflow.com/questions/4974668/what-is-the-unicode-variation-selector
  $('.flex').last().append($(`<div>‚ôªÔ∏è</div>`)); // green recycle &#x267b;&#xfe0f;
  console.log(emoji.join(","));
  onChange();

  $('.flex > div').click(function(e) {
    if (/^\d+$/.test(e.target.textContent))
      startLoop();

    if(['‚ôªÔ∏è','üíñ'].includes(e.target.innerHTML)) {
      if (timeoutID !== null) {
        clearTimeout(timeoutID);
        timeoutID = null;
      }
      if (loopInterval !== null) {
        clearInterval(loopInterval); // Stop the loop
        loopInterval = null;
      }
      init();
      return false;
    }

    // Prevent clicking on already revealed cards
    if (e.target.innerHTML !== '&nbsp;') {
      return false;
    }

    if (timeoutID !== null) {
      clearTimeout(timeoutID);
      timeoutID = null;

      if (card1 !== null && card2 !== null) {
        // Force hide the mismatched pair immediately
        $('#' + card1).html('&nbsp;');
        $('#' + card2).html('&nbsp;');

        if (guess[card1] !== 1 || guess[card2] !== 1) {
          errors++;
        }
      }
      card1 = card2 = null;
    }

    let id = e.target.id;
    guess[id]++;
    $(this).html(animals[id]);

    if (card1 === null) {
      card1 = id;

    } else if (animals[card1] === animals[id]) {
      // Match!
      card1 = null;

      let remaining = 0;
      $('.flex:first > div').each((_, e) => {
        if (e.innerHTML === '&nbsp;') remaining++;
      });

      if (!remaining) {
        if (errors){
          $('.flex:last > div').html(`<b><font color="deeppink">${errors}</font></b>`);
          setTimeout(() => {
            $('.flex:last > div').html('‚ôªÔ∏è');
          }, 1500);
        } else {
          startLoop();
        }
      }

    } else {
      // Mismatch ‚Äî show for 1 second (or until player clicks again)
      card2 = id;

      timeoutID = setTimeout(function() {
        if (guess[card1] !== 1 || guess[card2] !== 1) {
          errors++;
        }
        $('#' + card1).html('&nbsp;');
        $('#' + card2).html('&nbsp;');
        card1 = card2 = null;
        timeoutID = null;
      }, 1000);
    }

    return false;
  });
}

function onChange() {
  h = $(window).height(), w = $(window).width(), m, c;
  m = h > w ? w - 20 : (h - 20) * 4 / 6;
  c = m / 4 - 20;
  $('body').css('font-size', c/2.1); // chromium on android won't display emoji when c/2
  $('.flex').first().css({'width': m, 'height': m});
  $('.flex').last().css({'width': m/4, 'height': m/4, 'top': Math.min(c,h-m-c-40), 'left': m*3/8});
  $('.flex > div').css({'width': c});                       //          ipad mini
  // $('#dbg').append(`${h},${w},${m},${c},7<br>`);
  console.log(`h= ${h}, w ${w}, m= ${m.toFixed(3)}, c= ${c.toFixed(3)}`);
}

$(document).ready(function() {
  $(window).resize(onChange);
  init();
});

const numberOfHearts = 20;
const getRandomColor = () => "#" + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

// Function to create heart particles at a specific location with a specific color
function createHeart(x, y) {
    let color = getRandomColor(); 
    for (let i = 0; i < numberOfHearts; i++) {
        if (i == numberOfHearts / 2) color = getRandomColor(); 
        const heart = document.createElement("div");
        heart.classList.add("heart-firework");
        heart.textContent = "‚ô•";
        document.body.appendChild(heart);

        // Position the heart
        heart.style.left = `${x + c}px`;
        heart.style.top = `${y + c}px`;

        heart.style.setProperty('--heart-size', `${c}px`); 
        heart.style.setProperty('--heart-color', color); 

        // Calculate a random direction and distance
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 500 + 100;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;

        // Set the CSS variables for the animation
        heart.style.setProperty('--dx', `${dx}px`);
        heart.style.setProperty('--dy', `${dy}px`);

        // Remove the element after the animation finishes
        setTimeout(() => {
            heart.remove();
        }, 1500);
    }
}

// Function to trigger a random firework explosion
function triggerRandomFirework() {
    // Random positions within the viewport
    const x = Math.random() * (m - 2*c); // window.innerWidth;
    const y = Math.random() * (window.innerHeight - 2*c);
    createHeart(x, y); // Pass the color
}
</script></body></html>
